# Ручная работа
Author: `@greg0r0`

## Desc

На нашу компанию совершили атаку рансомварью. Денег на полноценное расследование инцидента у нас нет, поэтому мы выдали эту задачу нашему сисадмину. Он там чет сделал, нашел малварь, пореверсил её и сказал что там **обычное гаммирование, размер ключа 32 байта**. Пока он восстанавливает инфраструктуру - попробуй восстановить вот этот важный документ из бухгалтерии.

[task.pdf.encrypted](../public/task.pdf.encrypted)

## Flag

```
ptctf{g00d_w0rk_futur3_crypt0_3nthus14st}
```

## Solve

Решим этот таск при помощи [кибершефа](https://gchq.github.io/CyberChef/). Советуем сохранить этот очень умный калькулятор в закладки :)

> Если хотите получить полностью расшифрованный файл - замените хексы в Input на ваш файл и уберите из рецепта "From Hex"

> Более умный способ решения такого рода тасков - [Метод Касиски](https://ru.wikipedia.org/wiki/%D0%9C%D0%B5%D1%82%D0%BE%D0%B4_%D0%9A%D0%B0%D1%81%D0%B8%D1%81%D0%BA%D0%B8). Но т.к. основное тело PDF сжато - метод не подходит. 

Стадия 1 - подготавливаем рецепт, зная что размер ключа 32 байта.
[Подготовка](https://gchq.github.io/CyberChef/#recipe=XOR(%7B'option':'Hex','string':'0000000000000000000000000000000000000000000000000000000000000000'%7D,'Standard',false)To_Hexdump(32,false,false,true))
 
Стадия 2 - мы знаем, что в хедере PDF Документа всегда есть байты `%PDF-1.` Если мы поксорим байты файла с этими байтами, то получим байты ключа на позиции `%PDF-1.`, в силу свойств симметричности функции xor. Получаем байты ключа [0,7] - `01020304040809`

[Ссылка на рецепт](https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')XOR(%7B'option':'Latin1','string':'%25PDF-1.'%7D,'Standard',false)To_Hexdump(32,false,false,true)&input=MjQ1MjQ3NDIgMjkzOTI3M2QgZjJhMjM2NjQgZGZhMGExYWMNCmVjZGYyMTMwIDM5YzBiZWRmIGVlMDgzZjVkIGFjZTc4NjhmDQo2NDJkNDA2NSA3MDY5NjU2NSA5ODg3NDNiMCAwZDcwNjc4MQ0KZDRjZTMxMjAgNGI4MDkwZDQgOGQ2NTJiMTMgZjY5ZWFkYWENCjI4MjIyYzU3IDcwN2E3YzY5IDhiZmM2MWI0IDBmNDc3YmNlDQo5MmNlMzAzNiAzOTlmZmNlNyBjYzRmNjIxMyBlOGZhOTE5OQ0KNmUzZTNmMmIgNDk2OTdiNjEgOWFjYzMzYTUgMTg2MDcxOWYNCmQ4YzE0YzY1IDZkY2ViOGQ0IDk3NjMyMzUyIGI3OTNjZmRmDQo1MzJkNTU2ZCA2MTdmNmM3OCBhZmRhNzZiNyAwZjY3NzFjZg0KODU4YjcyMjAgMmE5YWZjODUgYzM1MDNkNWYgOGViOTlhOTE)

Стадия 3 - Мы знаем, что валидные версии PDF - 1.5, 1.7, etc. Т.е. мы знаем еще один байт ключа, всего 8. Но как определить версию? Так же, как и будем добирать большую часть байт ключа: В формате PDF находится очень много метаданных, которые будут нам полезны. Вернее, название полей этих метаданных. Если применить ключ с правильным размером, то мы сможем увидеть части названий:

```
0102030404080900000000000000000000000000000000000000000000000000
```

```
00000000  25 50 44 46 2d 31 2e 3d f2 a2 36 64 df a0 a1 ac  |%PDF-1.=ò¢6dß ¡¬|
00000010  ec df 21 30 39 c0 be df ee 08 3f 5d ac e7 86 8f  |ìß!09À¾ßî.?]¬ç..|
00000020  65 2f 43 61 74 61 6c 65 98 87 43 b0 0d 70 67 81  |e/Catale..C°.pg.|  <<
00000030  d4 ce 31 20 4b 80 90 d4 8d 65 2b 13 f6 9e ad aa  |ÔÎ1 K..Ô.e+.ö..ª|
00000040  29 20 2f 53 74 72 75 69 8b fc 61 b4 0f 47 7b ce  |) /Strui.üa´.G{Î|  <<
00000050  92 ce 30 36 39 9f fc e7 cc 4f 62 13 e8 fa 91 99  |.Î069.üçÌOb.èú..|
00000060  6f 3c 3c 2f 4d 61 72 61 9a cc 33 a5 18 60 71 9f  |o<</Mara.Ì3¥.`q.|  <<
00000070  d8 c1 4c 65 6d ce b8 d4 97 63 23 52 b7 93 cf df  |ØÁLemÎ¸Ô.c#R·.Ïß|
00000080  52 2f 56 69 65 77 65 78 af da 76 b7 0f 67 71 cf  |R/Viewex¯Úv·.gqÏ|  <<
00000090  85 8b 72 20 2a 9a fc 85 c3 50 3d 5f 8e b9 9a 91  |..r *.ü.ÃP=_.¹..|
000000a0  64 6f 62 6a 0d 0a 32 2a cf 88 7c b3 00 18 1e 9d  |dobj..2*Ï.|³....|
000000b0  da c1 55 79 69 ca f3 e5 82 65 66 12 ac f0 90 8a  |ÚÁUyiÊóå.ef.¬ð..|
000000c0  6e 74 20 31 2f 4b 69 6e 8c f3 33 e2 4a 25 34 f3  |nt 1/Kin.ó3âJ%4ó|
000000d0  bb ce 3f 3e 14 a5 b9 db 87 6d 61 0b 8e b9 cc df  |»Î?>.¥¹Û.ma..¹Ìß|
000000e0  30 20 6f 62 6a 0d 0a 36 c3 87 47 a8 1a 70 3b f1  |0 obj..6Ã.G¨.p;ñ|
000000f0  87 89 64 2f 49 ce ae d0 8d 76 23 53 a3 83 df ad  |..d/IÎ®Ð.v#S£.ß.|
00000100  2f 52 65 73 6f 75 72 69 9a db 2f ed 45 53 7b cf  |/Resouri.Û/íES{Ï|  <<
00000110  92 d2 3d 2f 5f 9e fc 80 c3 32 23 33 bd 8d d0 ba  |.Ò=/_.ü.Ã2#3½.Ðº|
00000120  78 74 47 53 74 61 74 6f c3 94 3c 96 39 22 34 96  |xtGStatoÃ.<.9"4.|
00000130  c6 de 21 52 36 e8 8f 8d c3 3a 23 51 a3 e1 c1 c1  |ÆÞ!R6è..Ã:#Q£áÁÁ|
```

Подобрав нужный зашифрованный байт (Как вариант - понимая, что по оффсету 0x43 у нас идет поле /Struct...) мы получаем нужную версию 1.7 и правильный байты ключа '0aff'.

[Результат с таким ключом](https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')XOR(%7B'option':'Hex','string':'010203040408090aff0000000000000000000000000000000000000000000000'%7D,'Standard',false)To_Hexdump(32,true,false,true)&input=MjQ1MjQ3NDIgMjkzOTI3M2QgZjJhMjM2NjQgZGZhMGExYWMNCmVjZGYyMTMwIDM5YzBiZWRmIGVlMDgzZjVkIGFjZTc4NjhmDQo2NDJkNDA2NSA3MDY5NjU2NSA5ODg3NDNiMCAwZDcwNjc4MQ0KZDRjZTMxMjAgNGI4MDkwZDQgOGQ2NTJiMTMgZjY5ZWFkYWENCjI4MjIyYzU3IDcwN2E3YzY5IDhiZmM2MWI0IDBmNDc3YmNlDQo5MmNlMzAzNiAzOTlmZmNlNyBjYzRmNjIxMyBlOGZhOTE5OQ0KNmUzZTNmMmIgNDk2OTdiNjEgOWFjYzMzYTUgMTg2MDcxOWYNCmQ4YzE0YzY1IDZkY2ViOGQ0IDk3NjMyMzUyIGI3OTNjZmRmDQo1MzJkNTU2ZCA2MTdmNmM3OCBhZmRhNzZiNyAwZjY3NzFjZg0KODU4YjcyMjAgMmE5YWZjODUgYzM1MDNkNWYgOGViOTlhOTE)

Таким образом можно подобрать все остальные байты ключа, информацию о названии полей метаданных можно либо нагуглить, либо посмотреть в структуры документов, которые у вас уже есть. Полезны будут те поля, названия которых наиболее длинные. Как пример:
- `/Resources<</Font`
- `<</Filter/FlateDecode/Length `
- ` /StructTreeRoot `
- `/Lang(ru-RU)`
- `<</Type/Catalog/Pages `
- и т.д.

Получаеем Ключ (в хексах):
```
010203040408090affa813d16a1514a1e6ee010019afdcb5e302036183b3ffff
```
[Пример расшифрования кусочка PDF](https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')XOR(%7B'option':'Hex','string':'010203040408090affa813d16a1514a1e6ee010019afdcb5e302036183b3ffff'%7D,'Standard',false)To_Hexdump(32,true,false,true)&input=MjQ1MjQ3NDIgMjkzOTI3M2QgZjJhMjM2NjQgZGZhMGExYWMNCmVjZGYyMTMwIDM5YzBiZWRmIGVlMDgzZjVkIGFjZTc4NjhmDQo2NDJkNDA2NSA3MDY5NjU2NSA5ODg3NDNiMCAwZDcwNjc4MQ0KZDRjZTMxMjAgNGI4MDkwZDQgOGQ2NTJiMTMgZjY5ZWFkYWENCjI4MjIyYzU3IDcwN2E3YzY5IDhiZmM2MWI0IDBmNDc3YmNlDQo5MmNlMzAzNiAzOTlmZmNlNyBjYzRmNjIxMyBlOGZhOTE5OQ0KNmUzZTNmMmIgNDk2OTdiNjEgOWFjYzMzYTUgMTg2MDcxOWYNCmQ4YzE0YzY1IDZkY2ViOGQ0IDk3NjMyMzUyIGI3OTNjZmRmDQo1MzJkNTU2ZCA2MTdmNmM3OCBhZmRhNzZiNyAwZjY3NzFjZg0KODU4YjcyMjAgMmE5YWZjODUgYzM1MDNkNWYgOGViOTlhOTENCjY1NmQ2MTZlIDA5MDIzYjJhIGNmODg3Y2IzIDAwMTgxZTlkDQpkYWMxNTU3OSA2OWNhZjNlNSA4MjY1NjYxMiBhY2YwOTA4YQ0KNmY3NjIzMzUgMmI0MzYwNmUgOGNmMzMzZTIgNGEyNTM0ZjMNCmJiY2UzZjNlIDE0YTViOWRiIDg3NmQ2MTBiIDhlYjljY2RmDQozMTIyNmM2NiA2ZTA1MDMzNiBjMzg3NDdhOCAxYTcwM2JmMQ0KODc4OTY0MmYgNDljZWFlZDAgOGQ3NjIzNTMgYTM4M2RmYWQNCjJlNTA2Njc3IDZiN2Q3YjY5IDlhZGIyZmVkIDQ1NTM3YmNmDQo5MmQyM2QyZiA1ZjllZmM4MCBjMzMyMjMzMyBiZDhkZDBiYQ0KNzk3NjQ0NTcgNzA2OTdkNmYgYzM5NDNjOTYgMzkyMjM0OTYNCmM2ZGUyMTUyIDM2ZTg4ZjhkIGMzM2EyMzUxIGEzZTFjMWMxDQoyZTVhNGM2NiA2ZTZkNmE3ZSBjMzk0M2M5OCAwNzc0NzNjNA0KZGZjZTM4MjAgMjk4ZjhlOWEgYWE2ZjYyMDYgZTY4MmNlZGYNCjMwMzMyMzM0IDI0NWEyNjQzIDkyYzk3NGI0IDViMjYzNDkwDQpkNWNlMzEyMCA0YjkxZTI5YSBiMzcwNmMwMiBkMGQ2OGJhNA0KMmU1MjQ3NDIgMmI1YzZjNzIgOGI4NzVhYmMgMGI3MjcxZTMNCmM5YTc2YzYxIDdlY2E5ZjlhIGFhNmY2MjA2IGU2ZmFhMmRmDQozZjNjMmM0OSA2MTZjNjA2YiBiZGM3NmI4YSA0YTI1MzQ5MQ0KYzZkYjM4MzUgMzc5Y2VlOTUgZGIzNjMyNGYgYmE4MWEyZGYNCjJlNDE2YzZhIDcwNmQ2NzdlIDhjODgyN2YxIDVhMzU0NjhlDQphMTljNmU3NSA2OTkzZTA5YSBiNzdiNzMwNCBhY2Y0OGQ5MA0KNzQ3MjJjNTcgMmI1YzdiNmIgOTFkYjYzYjAgMTg3MDdhYzINCjlmYzE0MjUzIDM2ZWJiOWMzIDhhNjE2NjMzIGM0ZjFjMWMxDQoyZTU2NjI2NiA3NzI3NWEyNSBhY2RjNjFhNCAwOTYxNDRjMA0KOTQ4YjZmNzQgNmE4ZmVjOGIgZGQwZjA5MDQgZWRkNzkwOWQNCjZiMGYwOTMwIDI0MzgyOTY1IDlkYzIxZWRiIDU2MjkzYmU3DQo4ZjgyNzU2NSA2YjgwOWFkOSA4Mjc2NjYyNSBlNmQwOTA5Yg0KNjQyZDRmNjEgNmE2ZjdkNjIgZGY5YjIyZTUgNWIyNDJhOWYNCmViZTQ3Mjc0IDZiY2FiZGQ4IGVlMDg3YmZkIDM3MmViMjUwDQo2Y2JmNzE5MSBmZmE3ZmRmNCA3ODdkMTc3NSBjNmZlZmJhZQ0KY2ZhNDIyZjcgOWY4Nzk0MjQgYTM1ZThhNjcgMjEzMjcxM2QNCmE0NzMwZDJjIGY0ZjcyYzM2IDM5ZmI4ZGFhIDA3NTc4MzcyDQpkZjk1OTUzZCAyNDkyMzFjNyA1YTVlNTZjZiA3NjQ5M2M0MA0KN2VmZmY2NWIgZmJlOTE2ZjUgMDdhNzZjYWIgY2ZhYWVkM2ENCjMxMzFmZmU5IDk2MDBhMzRiIDFlYjVmNzJmIDc5MDQyOTMzDQphZWY2ZTliZiBiYjYzNzBhNyA2OTc3YTg2ZCA5NGMyMmI1Yw0KMTgzNTdlZmEgMmUwMDIzNDQgMTg2ZDdjOWEgNjQ2YzgwMDQNCmMyYmRjZWFiIDk4ZDdhMGI3IDAxNTRjY2FmIDk1NThhMTcyDQpjZDUxNTc3ZiBmZWVjNDYwNiA1ZWQ1MmE5OCBmNjU5MDIwMg0KN2U5ZWFjYmIgZjhlN2RhZmUgMTQ4NzU1ZmEgYmFjYWViNWYNCjNkOTFmZjU3IGI2ZDAyMWVhIGJkN2RmZDE2IDNjNGMwOTg4)