# Просто сказка
Author: `denis`

## Desc

> RE

Все, что так близко нашему сердцу.

[Сэмпл](./hare.7z)

## Flag

```
ptctf{fr0m_st4nd0ff_w1th_love_4nd_t3nd3rn3ss}

```

## Solve

### Описание задачи

Игроку дан сэмпл малвари, которая устроена по принципу матрешки:
Powershell -> Powershell -> VBS -> Python

Архив ("Заяц") содержит первый слой, который называет "Утка", в котором обфусцированный код расшифровывает обфусцированный скрипт на VBS ("Яйцо"), который разжимает скрипт на Python ("Игла"), который делает запрос на сервер ctf.standoff.it. Флаг будет ксориться с константой и отправляться в заголовке Flag.

Архив от папки с исходниками: sotired
Архив от папки с заданием:    infected

### Решение
1. (Hare -> Duck) Следующий этап получается очевидно: открыть архив.
2. (Duck -> Egg) Этот скрипт на Powershell выполняет расшифровку полезной нагрузки с помощью AES. Тут используется простая замена имен переменных.
3. (Egg -> Needle) Здесь я сделал кастомный обфускатор, который меняет текущий символ на случайную арифметическую операцию. Вдохновлялся этим: https://github.com/DoctorLai/VBScript_Obfuscator. После снятия обфускации (просто путем выполнения Eval(data)), игроки получат vbs, распаковывающий следующий этап из base64 строки.
4. (Egg -> flag) Последний этап, наконец-то, финальный скрипт на питоне, который формирует http-запрос с помощью requests. Флаг хранится как ROT13 кодированная строка, которая декодируется, ксорится с 1 и помещается в заголовок user-agent.
